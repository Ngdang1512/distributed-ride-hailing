<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ride Hailing App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Ph·∫ßn B·∫£n ƒë·ªì chi·∫øm ph·∫ßn l·ªõn m√†n h√¨nh */
        #map { flex-grow: 1; width: 100%; z-index: 1; }

        /* Panel ƒëi·ªÅu khi·ªÉn m√¥ ph·ªèng App ƒëi·ªán tho·∫°i */
        .app-panel {
            background: white; padding: 20px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2;
            position: relative; margin-top: -20px;
        }
        h2 { margin: 0 0 15px 0; font-size: 18px; color: #333; text-align: center;}
        
        .location-info { display: flex; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px;}
        .coords { font-size: 12px; color: #666; display: flex; flex-direction: column; justify-content: center; }
        
        button {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-book { background-color: #00bf63; color: white; } /* M√†u Grab */
        .btn-book:active { transform: scale(0.98); }
        .btn-finish { background-color: #ff3b30; color: white; display: none; margin-top: 10px;}

        /* Hi·ªÉn th·ªã tr·∫°ng th√°i */
        #status-bar { 
            display: none; margin-top: 15px; padding: 10px; border-radius: 8px; 
            text-align: center; font-size: 14px; 
        }
        .success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="app-panel">
        <h2>üöñ ƒê·∫∑t xe RideHailing</h2>
        
        <div class="location-info">
            <div style="font-size: 24px;">üìç</div>
            <div class="coords">
                <strong id="address-text">ƒêang ch·ªçn v·ªã tr√≠...</strong>
                <span>Lat: <span id="lat">21.0285</span> | Lng: <span id="lng">105.8542</span></span>
            </div>
        </div>

        <button id="btnBook" class="btn-book" onclick="bookRide()">ƒê·∫∑t xe ngay</button>
        <button id="btnFinish" class="btn-finish" onclick="finishTrip()">üèÅ Ho√†n th√†nh chuy·∫øn</button>

        <div id="status-bar"></div>
    </div>

    <script>
        // 1. Kh·ªüi t·∫°o b·∫£n ƒë·ªì (M·∫∑c ƒë·ªãnh H·ªì G∆∞∆°m)
        var map = L.map('map').setView([21.0285, 105.8542], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // T·∫°o Marker (Ghim ƒë·ªè) c√≥ th·ªÉ k√©o th·∫£
        var marker = L.marker([21.0285, 105.8542], {draggable: true}).addTo(map);

        // S·ª± ki·ªán: Khi k√©o marker -> C·∫≠p nh·∫≠t t·ªça ƒë·ªô
        marker.on('dragend', function(event) {
            var position = marker.getLatLng();
            updateUI(position.lat, position.lng);
        });

        // S·ª± ki·ªán: Khi b·∫•m v√†o b·∫£n ƒë·ªì -> Di chuy·ªÉn marker t·ªõi ƒë√≥
        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            updateUI(e.latlng.lat, e.latlng.lng);
        });

        function updateUI(lat, lng) {
            // L√†m tr√≤n s·ªë ƒë·∫πp
            document.getElementById('lat').innerText = lat.toFixed(4);
            document.getElementById('lng').innerText = lng.toFixed(4);
            
            // Logic gi·∫£ l·∫≠p ƒë·ªãa ch·ªâ
            var address = "V·ªã tr√≠ ƒë√£ ch·ªçn";
            if (lat > 17) address = "Khu v·ª±c Mi·ªÅn B·∫Øc (HN)";
            else address = "Khu v·ª±c Mi·ªÅn Nam (HCM)";
            document.getElementById('address-text').innerText = address;
        }

        // --- LOGIC G·ªåI API ---
        let currentTripId = null;
        let currentRegion = null;

        async function bookRide() {
            const lat = parseFloat(document.getElementById('lat').innerText);
            const lng = parseFloat(document.getElementById('lng').innerText);
            const statusDiv = document.getElementById('status-bar');

            statusDiv.style.display = 'block';
            statusDiv.className = '';
            statusDiv.innerHTML = 'üîÑ ƒêang t√¨m t√†i x·∫ø g·∫ßn b·∫°n...';

            try {
                const response = await fetch('/api/Booking/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        lat: lat, 
                        lng: lng, 
                        pickupLocation: lat > 17 ? "H√† N·ªôi" : "S√†i G√≤n" 
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    statusDiv.className = 'success';
                    statusDiv.innerHTML = `‚úÖ <b>T√†i x·∫ø ƒë·∫øn r·ªìi!</b><br>${data.driver} (${data.region})`;
                    
                    // L∆∞u th√¥ng tin chuy·∫øn ƒëi ƒë·ªÉ l√°t n·ªØa tr·∫£ kh√°ch
                    currentTripId = data.tripId;
                    currentRegion = data.region;

                    // ƒê·ªïi n√∫t sang Tr·∫£ kh√°ch
                    document.getElementById('btnBook').style.display = 'none';
                    document.getElementById('btnFinish').style.display = 'block';
                } else {
                    statusDiv.className = 'error';
                    statusDiv.innerHTML = `‚ùå ${data.message}`;
                }
            } catch (err) {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `‚ùå L·ªói k·∫øt n·ªëi Server`;
            }
        }

        async function finishTrip() {
            if (!currentTripId) return;
            const statusDiv = document.getElementById('status-bar');
            statusDiv.innerHTML = 'üîÑ ƒêang thanh to√°n...';

            try {
                const response = await fetch('/api/Booking/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        tripId: currentTripId, 
                        region: currentRegion,
                        endLat: parseFloat(document.getElementById('lat').innerText),
                        endLng: parseFloat(document.getElementById('lng').innerText)
                    })
                });

                if (response.ok) {
                    statusDiv.className = 'success';
                    statusDiv.innerHTML = `‚úÖ <b>Chuy·∫øn ƒëi ho√†n th√†nh!</b><br>C·∫£m ∆°n qu√Ω kh√°ch.`;
                    
                    // Reset n√∫t v·ªÅ ban ƒë·∫ßu
                    document.getElementById('btnBook').style.display = 'block';
                    document.getElementById('btnFinish').style.display = 'none';
                    currentTripId = null;
                } else {
                    statusDiv.className = 'error';
                    statusDiv.innerHTML = `‚ùå L·ªói khi tr·∫£ kh√°ch`;
                }
            } catch (err) {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `‚ùå L·ªói k·∫øt n·ªëi`;
            }
        }
    </script>
</body>
</html>